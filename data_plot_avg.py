import matplotlib.pyplot as plt
from scipy.stats import pearsonr
import numpy as np
from statsmodels.nonparametric.smoothers_lowess import lowess
import pandas as pd
from scipy.stats import spearmanr

#data for all queries run on the TPC-H, TPC-DS, and JOB databases (excluding the queries that were skipped)
data = [
    ['2.sql', 0, 23.372000000000014],
    ['22.sql', 0, 25.37766666666667],
    ['14.sql', 0, 12.049666666666639],
    ['3.sql', 3, 297.79733333333326],
    ['16.sql', 1, 130.36133333333333],
    ['5.sql', 0, 125.85066666666667],
    ['7.sql', 0, 124.50433333333324],
    ['20.sql', 8, 1111.4473333333333],
    ['15.sql', 5, 332.528],
    ['13.sql', 0, 36.300333333333356],
    ['19.sql', 0, 18.53366666666666],
    ['18.sql', 0, 148.13433333333333],
    ['21.sql', 0, 76.90333333333335],
    ['17.sql', 0, 49.705333333333364],
    ['1.sql', 0, 949.2836666666666],
    ['11.sql', 1, 2.98166666666666],
    ['10.sql', 0, 164.54399999999998],
    ['8.sql', 0, 170.22199999999998],
    ['12.sql', 0, 173.44600000000003],
    ['9.sql', 14, 46.37033333333337],
    ['6.sql', 0, 181.57066666666665],
    ['4.sql', 0, 0.2486666666666667],
    ['3a.sql', 11, 3473.4060000000004],
    ['24a.sql', 14, 256.3686666666668],
    ['32b.sql', 3, 404.8296666666667],
    ['33c.sql', 20, 186.545],
    ['8a.sql', 3, 1904.6726666666661],
    ['30b.sql', 4, 37.911666666666676],
    ['21b.sql', 18, 7.6030000000000015],
    ['27b.sql', 23, 48.139],
    ['25c.sql', 0, 748.3549999999999],
    ['1c.sql', 3, 4.088],
    ['2d.sql', 0, 97.02833333333331],
    ['18a.sql', 13, 18923.682333333334],
    ['2c.sql', 0, 17.043999999999983],
    ['7a.sql', 4, 187.98533333333333],
    ['6e.sql', 0, 4.085999999999999],
    ['8b.sql', 8, 42.86333333333332],
    ['3c.sql', 11, 2092.213666666667],
    ['18b.sql', 7, 295.5276666666667],
    ['5c.sql', 0, 29.701999999999998],
    ['15b.sql', 11, 12.333333333333334],
    ['11d.sql', 8, 64.96199999999999],
    ['22d.sql', 0, 219.31699999999992],
    ['30a.sql', 0, 44.5463333333333],
    ['17b.sql', 4, 734.7060000000001],
    ['17c.sql', 5, 217.41199999999995],
    ['28a.sql', 15, 665.3806666666668],
    ['8d.sql', 12, 528.0320000000002],
    ['11a.sql', 16, 10.178666666666668],
    ['11b.sql', 13, 29.92866666666667],
    ['33a.sql', 7, 3.794333333333334],
    ['27c.sql', 21, 7.038666666666668],
    ['14c.sql', 0, 85.71033333333332],
    ['26b.sql', 16, 643.5203333333334],
    ['28b.sql', 13, 1247.8416666666665],
    ['5b.sql', 5, 44.34700000000001],
    ['32a.sql', 3, 2.7953333333333332],
    ['33b.sql', 26, 20.808000000000003],
    ['22b.sql', 0, 22.185666666666663],
    ['31a.sql', 10, 7749.860333333334],
    ['23c.sql', 5, 54.97200000000001],
    ['27a.sql', 23, 39.62166666666666],
    ['20b.sql', 9, 24796.96266666667],
    ['14a.sql', 0, 25.866666666666685],
    ['29c.sql', 32, 2496.027],
    ['10a.sql', 4, 59.73499999999998],
    ['23a.sql', 5, 4.736],
    ['17e.sql', 0, 246.9299999999997],
    ['25a.sql', 0, 173.5280000000001],
    ['29a.sql', 35, 85.43066666666668],
    ['20c.sql', 9, 25256.581000000002],
    ['6f.sql', 0, 87.13600000000012],
    ['18c.sql', 11, 1812.0763333333334],
    ['19c.sql', 16, 7054.379000000001],
    ['1d.sql', 0, 0.06733333333333334],
    ['30c.sql', 8, 1247.5833333333333],
    ['2a.sql', 0, 4.624666666666674],
    ['26c.sql', 18, 35806.471333333335],
    ['9b.sql', 12, 1778.4223333333332],
    ['9a.sql', 14, 2423.1366666666668],
    ['7b.sql', 4, 6.4756666666666645],
    ['31b.sql', 16, 189.56466666666665],
    ['19d.sql', 8, 3667.2126666666663],
    ['16b.sql', 0, 361.27100000000064],
    ['19a.sql', 18, 2503.849666666667],
    ['19b.sql', 22, 3368.1776666666665],
    ['12a.sql', 0, 28.169333333333338],
    ['16c.sql', 0, 43.49533333333333],
    ['13b.sql', 10, 34.88233333333335],
    ['2b.sql', 0, 29.150666666666666],
    ['5a.sql', 7, 69.54833333333332],
    ['7c.sql', 15, 5305.371666666667],
    ['13a.sql', 0, 184.0733333333334],
    ['24b.sql', 12, 2.329333333333333],
    ['15a.sql', 16, 628.3149999999999],
    ['6b.sql', 0, 39.125],
    ['17d.sql', 5, 373.65599999999995],
    ['13c.sql', 10, 22.994999999999965],
    ['16a.sql', 0, 5.384999999999991],
    ['28c.sql', 9, 124.21033333333328],
    ['26a.sql', 19, 10504.591666666667],
    ['12b.sql', 11, 0.29266666666666674],
    ['10c.sql', 15, 1274.9676666666667],
    ['22a.sql', 0, 66.73933333333336],
    ['1a.sql', 3, 0.6466666666666666],
    ['12c.sql', 0, 247.3256666666666],
    ['29b.sql', 26, 94.07199999999996],
    ['4a.sql', 10, 972.9666666666667],
    ['3b.sql', 6, 1360.3100000000002],
    ['14b.sql', 5, 5.5423333333333415],
    ['1b.sql', 0, 0.059333333333333356],
    ['9c.sql', 10, 2163.9613333333336],
    ['13d.sql', 0, 547.6499999999997],
    ['16d.sql', 0, 32.197333333333326],
    ['15d.sql', 20, 1628.6206666666665],
    ['6a.sql', 0, 3.9416666666666664],
    ['8c.sql', 12, 3595.9876666666664],
    ['20a.sql', 9, 57445.304000000004],
    ['9d.sql', 0, 724.2959999999997],
    ['15c.sql', 20, 1525.2679999999998],
    ['17a.sql', 0, 173.1843333333336],
    ['17f.sql', 0, 237.5716666666664],
    ['31c.sql', 13, 7916.041333333334],
    ['11c.sql', 12, 64.72066666666667],
    ['6d.sql', 0, 196.5050000000001],
    ['21a.sql', 18, 29.32133333333333],
    ['23b.sql', 5, 36.508],
    ['4c.sql', 10, 1052.9553333333336],
    ['6c.sql', 0, 2.357666666666667],
    ['22c.sql', 0, 528.737],
    ['10b.sql', 0, 20.645666666666653],
    ['25b.sql', 9, 151.49966666666666],
    ['4b.sql', 9, 26.34166666666667],
    ['21c.sql', 13, 10.224666666666668],
    ['query86.sql', 0, 49.976],
    ['query35.sql', 0, 82.07133333333331],
    ['query21.sql', 5, 1241.1763333333333],
    ['query53.sql', 2, 41.723666666666645],
    ['query44.sql', 0, 303.60300000000007],
    ['query23.sql', 12, 684.3016666666666],
    ['query92.sql', 1, 9.681333333333333],
    ['query5.sql', 16, 849.6703333333334],
    ['query13.sql', 18, 629.0606666666666],
    ['query91.sql', 3, 17.414333333333335],
    ['query3.sql', 1, 2.4006666666666674],
    ['query47.sql', 1, 1412.4046666666666],
    ['query22.sql', 10, 3255.8710000000005],
    ['query9.sql', 0, 62.59799999999998],
    ['query98.sql', 4, 37.51633333333333],
    ['query37.sql', 2, 0.4706666666666665],
    ['query71.sql', 0, 38.092000000000006],
    ['query94.sql', 1, 12.255000000000004],
    ['query78.sql', 23, 1014.3190000000001],
    ['query50.sql', 1, 15.454333333333317],
    ['query41.sql', 0, 133.3786666666667],
    ['query70.sql', 13, 927.5839999999998],
    ['query69.sql', 4, 0.05266666666666662],
    ['query68.sql', 8, 59.88466666666665],
    ['query73.sql', 10, 56.456999999999994],
    ['query63.sql', 2, 24.717666666666656],
    ['query60.sql', 8, 1989.1203333333333],
    ['query61.sql', 8, 463.12833333333333],
    ['query79.sql', 5, 55.85966666666667],
    ['query62.sql', 8, 163.505],
    ['query84.sql', 6, 3.960333333333331],
    ['query81.sql', 0, 9718.42466666667],
    ['query12.sql', 1, 13.545000000000002],
    ['query19.sql', 0, 9.892000000000001],
    ['query24.sql', 1, 76.877],
    ['query32.sql', 1, 8.50366666666667],
    ['query20.sql', 4, 1.5416666666666679],
    ['query8.sql', 2, 76.472],
    ['query17.sql', 2, 62.553666666666665],
    ['query76.sql', 5, 107.91100000000002],
    ['query29.sql', 2, 19.168999999999997],
    ['query52.sql', 0, 69.36],
    ['query97.sql', 6, 294.6463333333332],
    ['query14.sql', 4, 2996.851666666667],
    ['query67.sql', 3, 1337.292666666667],
    ['query51.sql', 0, 177.0176666666667],
    ['query83.sql', 0, 8.321999999999997],
    ['query96.sql', 6, 173.11133333333336],
    ['query89.sql', 1, 152.97600000000003],
    ['query40.sql', 5, 17.098333333333333],
    ['query82.sql', 3, 199.91466666666665],
    ['query46.sql', 5, 106.7936666666667],
    ['query99.sql', 9, 206.17200000000003],
    ['query39.sql', 0, 158.47800000000007],
    ['query90.sql', 0, 23.933999999999997],
    ['query34.sql', 6, 51.785000000000004],
    ['query65.sql', 8, 252.15700000000007],
    ['query87.sql', 3, 163.40666666666664],
    ['query15.sql', 0, 4.5603333333333325],
    ['query66.sql', 0, 41.14266666666666],
    ['query42.sql', 0, 67.40066666666665],
    ['query85.sql', 18, 430.492],
    ['query16.sql', 1, 32.611],
    ['query38.sql', 3, 164.24533333333338],
    ['query31.sql', 2, 4356.565666666666],
    ['query33.sql', 10, 312.184],
    ['query28.sql', 0, 726.8283333333335],
    ['query43.sql', 6, 3833.676333333333],
    ['query95.sql', 10, 13065.538999999999],
    ['query93.sql', 0, 0.06766666666666667],
    ['query49.sql', 10, 206.08366666666666],
    ['query45.sql', 12, 32.92366666666667],
    ['query26.sql', 4, 416.80866666666674],
    ['query10.sql', 0, 39.07900000000001],
    ['query55.sql', 0, 55.883],
    ['query75.sql', 4, 237.2806666666667],
    ['query7.sql', 0, 100.43299999999995],
    ['query48.sql', 12, 591.5219999999999],
    ['query18.sql', 2, 76.85966666666667],
    ['query56.sql', 8, 438.3413333333333],
    ['query6.sql', 0, 12863.458999999997],
    ['query54.sql', 1, 8.811000000000005],
    ['query80.sql', 22, 20.747666666666607],
    ['query72.sql', 1, 1381.0216666666663],
    ['query58.sql', 0, 8.311],
    ['query88.sql', 64, 1317.9096666666665],
    ['query59.sql', 1, 1021.6659999999998],
    ['query2.sql', 0, 439.22900000000004],
    ['query64.sql', 19, 56.808333333333394],
    ['query36.sql', 1, 302.77633333333335],
    ['query77.sql', 21, 40.49799999999997],
    ['query57.sql', 1, 217.67800000000003],
    ['query27.sql', 0, 120.23333333333339],
    ['query25.sql', 2, 34.50466666666668],
    ['query30.sql', 0, 2053.773]
]

# Extract x (tree edit distance),
# y (execution time difference) and
# q (query) values from data
qs = [d[0] for d in data]
xs = [d[1] for d in data]
ys = [d[2] for d in data]

# remove outliers
qs = np.array(qs)
xs = np.array(xs)
ys = np.array(ys)
mean_x = np.mean(xs)
mean_y = np.mean(ys)
std_x = np.std(xs)
std_y = np.std(ys)

xxs = []
yys = []
for i in range(len(ys)):
    if np.abs(ys[i] - mean_y) < 2.0 * std_y:
        xxs.append(xs[i])
        yys.append(ys[i])
    else:
        print(f"aaaaa: {qs[i],xs[i],ys[i]}")
        # plt.plot(xs[i],ys[i],'rx')

# Calculate Pearson correlation coefficient
xs = xxs
ys = yys
corr, _ = pearsonr(xs, ys)
print('Pearsons correlation: %.3f' % corr)

# Lowess smoothing
# lowess_smoothed = lowess(ys, xs, frac=0.3)

# Convert the data to a DataFrame for easier analysis
# df = pd.DataFrame(data, columns=['query', 'ted', 'execution_time'])
# Calculate Spearman's Rank Correlation
# spearman_corr, spearman_p_value = spearmanr(df['ted'], df['execution_time'])
# Print the results
# print(f"Spearman's Rank Correlation Coefficient: {spearman_corr}")
# print(f"P-value: {spearman_p_value}")

#Fit a line of best fit to the data without outliers
m, b = np.polyfit(xs, ys, 1)

# Plot the data with the line of best fit
plt.scatter(xs, ys)
plt.plot(xs, m*np.array(xs) + b, color='red')
# plt.plot(lowess_smoothed[:, 0], lowess_smoothed[:, 1], color='green')
plt.xlabel("Tree Edit Distance")
plt.ylabel("Time Execution Difference (ms)")
plt.legend(['Data Points','Line of Best Fit '])#, 'Lowess Curve'])
plt.savefig("BestFit.png")
# plt.savefig("TrendCapture.png")
plt.show()


